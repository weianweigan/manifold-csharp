{"version":3,"file":"modelViewer.js","sources":["../../model-viewer-script.ts"],"sourcesContent":["// Copyright 2024 The Manifold Authors.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {Document, WebIO} from '@gltf-transform/core';\nimport {clearNodeTransform, flatten, prune} from '@gltf-transform/functions';\n\nimport Module, {Manifold, Mesh} from './built/manifold';\nimport {disposeMesh, Properties, readMesh, setupIO, writeMesh} from './gltf-io';\n\n// Set up gltf-transform\nconst io = setupIO(new WebIO());\nconst doc = new Document();\n\n\n// Set up Manifold WASM library\nconst wasm = await Module();\nwasm.setup();\nconst {Manifold, Mesh} = wasm;\n\n// Map of OriginalID to glTF material and attributes\nconst id2properties = new Map<number, Properties>();\n\n// Wrapper for gltf-io readMesh() that processes a whole glTF and stores the\n// properties in the above map. This function is simplified and intended only\n// for reading single-object glTFs, as it simply unions any extra meshes\n// together rather than returning a scene hierarchy.\nasync function readGLB(url: string) {\n  const manifolds = Array<Manifold>();\n  const docIn = await io.read(url);\n  await docIn.transform(flatten());\n  const nodes = docIn.getRoot().listNodes();\n  const ids = Array<number>();\n  for (const node of nodes) {\n    clearNodeTransform(node);\n    const gltfMesh = node.getMesh();\n    if (gltfMesh == null) continue;\n    const tmp = readMesh(gltfMesh);\n    if (tmp == null) continue;\n\n    const numID = tmp.runProperties.length;\n    const firstID = Manifold.reserveIDs(numID);\n    tmp.mesh.runOriginalID = new Uint32Array(numID);\n    for (let i = 0; i < numID; ++i) {\n      tmp.mesh.runOriginalID[i] = firstID + i;\n      ids.push(firstID + i);\n      id2properties.set(firstID + i, tmp.runProperties[i]);\n    }\n    manifolds.push(new Manifold(new Mesh(tmp.mesh)));\n  }\n  // pull in materials, TODO: replace with transfer() when available\n  const startIdx = doc.getRoot().listMaterials().length;\n  doc.merge(docIn);\n  doc.getRoot().listScenes().forEach((s) => s.dispose());\n  doc.getRoot().listBuffers().forEach((s) => s.dispose());\n  doc.getRoot().listAccessors().forEach((s) => s.dispose());\n  for (const [i, id] of ids.entries()) {\n    const material = doc.getRoot().listMaterials()[startIdx + i];\n    id2properties.get(id)!.material = material;\n  }\n\n  return Manifold.union(manifolds);\n}\n\n// Read static input glTFs\nconst space = await readGLB('/models/space.glb');\nconst moon = await readGLB('/models/moon.glb');\n\nconst node = doc.createNode();\ndoc.createScene().addChild(node);\n\n// Set up UI for operations\ntype BooleanOp = 'union'|'difference'|'intersection';\n\nfunction csg(operation: BooleanOp) {\n  push2MV(Manifold[operation](space, moon));\n}\n\ncsg('difference');\nconst selectElement = document.querySelector('select')!;\nselectElement.onchange = function() {\n  csg(selectElement.value as BooleanOp);\n};\n\n// The resulting glTF\nlet objectURL = '';\n\n// Set up download UI\nconst downloadButton = document.querySelector('#download') as HTMLButtonElement;\ndownloadButton.onclick = function() {\n  const link = document.createElement('a');\n  link.download = 'manifold.glb';\n  link.href = objectURL;\n  link.click();\n};\n\n// <model-viewer> element for rendering resulting glTF.\nconst mv = document.querySelector('model-viewer');\n\n// Use gltf-io and gltf-transform to convert the resulting Manifold to a glTF\n// and display it with <model-viewer>.\nasync function push2MV(manifold: Manifold) {\n  disposeMesh(node.getMesh()!);\n  const mesh = writeMesh(doc, manifold.getMesh(), id2properties);\n  node.setMesh(mesh);\n  await doc.transform(prune());\n\n  const glb = await io.writeBinary(doc);\n\n  const blob = new Blob([glb], {type: 'application/octet-stream'});\n  URL.revokeObjectURL(objectURL);\n  objectURL = URL.createObjectURL(blob);\n  (mv as any).src = objectURL;\n}"],"names":["io","setupIO","WebIO","doc","Document","wasm","Module","Manifold","Mesh","id2properties","readGLB","url","manifolds","docIn","flatten","nodes","ids","node","clearNodeTransform","gltfMesh","tmp","readMesh","numID","firstID","i","startIdx","s","id","material","space","moon","csg","operation","push2MV","selectElement","objectURL","downloadButton","link","mv","manifold","disposeMesh","mesh","writeMesh","prune","glb","blob"],"mappings":"+JAqBA,MAAMA,EAAKC,EAAQ,IAAIC,CAAO,EACxBC,EAAM,IAAIC,EAIVC,EAAO,MAAMC,IACnBD,EAAK,MAAM,EACX,KAAM,CAAC,SAAAE,EAAU,KAAAC,CAAQ,EAAAH,EAGnBI,MAAoB,IAM1B,eAAeC,EAAQC,EAAa,CAClC,MAAMC,EAAY,QACZC,EAAQ,MAAMb,EAAG,KAAKW,CAAG,EACzB,MAAAE,EAAM,UAAUC,EAAA,CAAS,EAC/B,MAAMC,EAAQF,EAAM,QAAQ,EAAE,UAAU,EAClCG,EAAM,QACZ,UAAWC,KAAQF,EAAO,CACxBG,EAAmBD,CAAI,EACjB,MAAAE,EAAWF,EAAK,UACtB,GAAIE,GAAY,KAAM,SAChB,MAAAC,EAAMC,EAASF,CAAQ,EAC7B,GAAIC,GAAO,KAAM,SAEX,MAAAE,EAAQF,EAAI,cAAc,OAC1BG,EAAUhB,EAAS,WAAWe,CAAK,EACzCF,EAAI,KAAK,cAAgB,IAAI,YAAYE,CAAK,EAC9C,QAASE,EAAI,EAAGA,EAAIF,EAAO,EAAEE,EAC3BJ,EAAI,KAAK,cAAcI,CAAC,EAAID,EAAUC,EAClCR,EAAA,KAAKO,EAAUC,CAAC,EACpBf,EAAc,IAAIc,EAAUC,EAAGJ,EAAI,cAAcI,CAAC,CAAC,EAE3CZ,EAAA,KAAK,IAAIL,EAAS,IAAIC,EAAKY,EAAI,IAAI,CAAC,CAAC,CACjD,CAEA,MAAMK,EAAWtB,EAAI,QAAQ,EAAE,gBAAgB,OAC/CA,EAAI,MAAMU,CAAK,EACXV,EAAA,UAAU,aAAa,QAASuB,GAAMA,EAAE,QAAA,CAAS,EACjDvB,EAAA,UAAU,cAAc,QAASuB,GAAMA,EAAE,QAAA,CAAS,EAClDvB,EAAA,UAAU,gBAAgB,QAASuB,GAAMA,EAAE,QAAA,CAAS,EACxD,SAAW,CAACF,EAAGG,CAAE,IAAKX,EAAI,UAAW,CACnC,MAAMY,EAAWzB,EAAI,QAAA,EAAU,gBAAgBsB,EAAWD,CAAC,EAC7Cf,EAAA,IAAIkB,CAAE,EAAG,SAAWC,CACpC,CAEO,OAAArB,EAAS,MAAMK,CAAS,CACjC,CAGA,MAAMiB,EAAQ,MAAMnB,EAAQ,mBAAmB,EACzCoB,EAAO,MAAMpB,EAAQ,kBAAkB,EAEvCO,EAAOd,EAAI,aACjBA,EAAI,YAAc,EAAA,SAASc,CAAI,EAK/B,SAASc,EAAIC,EAAsB,CACjCC,EAAQ1B,EAASyB,CAAS,EAAEH,EAAOC,CAAI,CAAC,CAC1C,CAEAC,EAAI,YAAY,EAChB,MAAMG,EAAgB,SAAS,cAAc,QAAQ,EACrDA,EAAc,SAAW,UAAW,CAClCH,EAAIG,EAAc,KAAkB,CACtC,EAGA,IAAIC,EAAY,GAGhB,MAAMC,EAAiB,SAAS,cAAc,WAAW,EACzDA,EAAe,QAAU,UAAW,CAC5B,MAAAC,EAAO,SAAS,cAAc,GAAG,EACvCA,EAAK,SAAW,eAChBA,EAAK,KAAOF,EACZE,EAAK,MAAM,CACb,EAGA,MAAMC,EAAK,SAAS,cAAc,cAAc,EAIhD,eAAeL,EAAQM,EAAoB,CAC7BC,EAAAvB,EAAK,SAAU,EAC3B,MAAMwB,EAAOC,EAAUvC,EAAKoC,EAAS,QAAA,EAAW9B,CAAa,EAC7DQ,EAAK,QAAQwB,CAAI,EACX,MAAAtC,EAAI,UAAUwC,EAAA,CAAO,EAE3B,MAAMC,EAAM,MAAM5C,EAAG,YAAYG,CAAG,EAE9B0C,EAAO,IAAI,KAAK,CAACD,CAAG,EAAG,CAAC,KAAM,0BAAA,CAA2B,EAC/D,IAAI,gBAAgBT,CAAS,EACjBA,EAAA,IAAI,gBAAgBU,CAAI,EACnCP,EAAW,IAAMH,CACpB"}